<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="yandex-verification" content="e062075972e46c0b" />
  
  
  
  
  <title>Redisson+sentinel race condition bug.</title>
  <meta name="description" content="Как я нашёл баг. Как то рас в одним вечерним вечером, я тестировал апликацию из связки redisson+redis+sentinel на кластере из трёх серверов. Написал скрипт который дропал каждый сервер по очереди на 5 минут, путем выключения интерфейса на сервере. Через некоторое непродолжитнльное время я получал ошибку “READONLY You can’t write against a read only replica..” создавалось ошущение что чтото не так с конфигурацией. Ещё пойзже я обнаружил что когда появляется эта ошибка, если в этот момент остановить скрипт дропа серверов, то переизбрания мастер сервера redis не происходит и ошибка остается навечно. Я конечно же проверил redis сервера нативным клиентом, оказалось что с ними всё в порядке всё пишется читается, просто мастер в этот момент не тот что у redisson. Отладка, изучение исходников. Поизучав продолжительное время исходные коды redisson проекта, а в частности инициализацию и работу опроса sentinel серверов в классе SentinelConnectionManager и всех наследуемых от него, но не как не мог понять где же может крыца ошибка, решил прибегнуть к отладке из intelliJ, чтобы посмотреть на runtime во очие. Тогда я запустил jvm с параметрами отладки примерно такими. java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8000 app.jar Поостнавливаясь рандомно, потыкая треды и найдя свой класс SentinelConnectionManager выяснилось что переменная SentinelConnectionManager.currentMaster которая указывает на текущего мастера соответсвует текущему настоящему мастеру как и на редис серверах, но соединение установленное redisson для мастер сервера SentinelConnectionManager.masterSlaveEntry.writeConnectionPool.entires имеет ClientConnectionsEntry с другим отличным от мастера ип адресом. Художественное отступление. Как же так получается воскликнул я и тот час смахнул стакан со стола. В котором был заварен долго не вытащенный, крепко перезаваренный пакетик моего любимого чая. Я схватился за волосы которые и без того покидали мою голову, и начал бегать по комнате в надежде разрешения ситуации. И через некоторое время мне пришла идея - всё разрешается отладкой. Отладка логированием. Я добавил сообщения отладки и идентификатор для треда опроса sentinel серверов и вот что я увидел: ./app.log:6691:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY scheduleChangeCheck run683 ./app.log:6692:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY checkState reqId = 683 ./app.log:6693:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY updateState reqId = 683 ./app.log:6694:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY checkMasterChange reqId = 683 ./app.log:6696:2023-03-06 02:15:02,131 INFO org.redisson.connection.SentinelConnectionManager [redisson-timer-4-1] MYMY updateState reqId = 683 future.whenComplete ./app.log:6716:2023-03-06 02:15:02,132 INFO org.redisson.connection.SentinelConnectionManager [redisson-timer-4-1] MYMY scheduleChangeCheck 683 ./app.log:6717:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY scheduleChangeCheck run684 ./app.log:6718:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY checkState reqId = 684 ./app.log:6719:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY updateState reqId = 684 ./app.log:6720:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY checkMasterChange reqId = 684 ./app.log:6721:2023-03-06 02:15:03,134 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY reqId = 684 checkMasterChange compareAndSet current = redis://172.18.20.168:6379 and newMaster = redis://172.18.20.166:6379 ./app.log:6756:2023-03-06 02:15:03,137 INFO org.redisson.connection.SingleEntry [redisson-netty-2-1] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry futures wait. ./app.log:6758:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 684 future.whenComplete ./app.log:6759:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 684 ./app.log:6765:2023-03-06 02:15:03,145 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry thenApply - complete. ./app.log:6766:2023-03-06 02:15:03,147 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 changeMaster -&amp;gt; CHANGED to 172.18.20.166/172.18.20.166:6379 ./app.log:6772:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY scheduleChangeCheck run685 ./app.log:6773:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY checkState reqId = 685 ./app.log:6774:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY updateState reqId = 685 ./app.log:6775:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY checkMasterChange reqId = 685 ./app.log:6776:2023-03-06 02:15:04,146 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-24] MYMY updateState reqId = 685 future.whenComplete ./app.log:6777:2023-03-06 02:15:04,146 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-24] MYMY scheduleChangeCheck 685 ./app.log:6778:2023-03-06 02:15:05,147 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-30] MYMY scheduleChangeCheck run686 По строкам: ./app.log:6759:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 684 ./app.log:6765:2023-03-06 02:15:03,145 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry thenApply - complete. Можно понять что callback setup setupMasterEntry отрабатывает после запуска очередного цикла опроса scheduleChangeCheck. И тут скорее всего и кроется race condition. ./app.log:12151:2023-03-06 02:24:58,094 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck run1265 ./app.log:12152:2023-03-06 02:24:58,094 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY checkState reqId = 1265 ./app.log:12168:2023-03-06 02:24:58,095 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1265 ./app.log:12169:2023-03-06 02:24:58,095 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY checkMasterChange reqId = 1265 ./app.log:12170:2023-03-06 02:24:58,096 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1265 future.whenComplete ./app.log:12171:2023-03-06 02:24:58,096 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1265 ./app.log:12230:2023-03-06 02:24:59,097 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY scheduleChangeCheck run1266 ./app.log:12231:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY checkState reqId = 1266 ./app.log:12247:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY updateState reqId = 1266 ./app.log:12248:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY checkMasterChange reqId = 1266 ./app.log:12249:2023-03-06 02:24:59,099 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1266 future.whenComplete ./app.log:12250:2023-03-06 02:24:59,099 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1266 ./app.log:12309:2023-03-06 02:25:00,071 INFO org.redisson.connection.SingleEntry [redisson-netty-2-8] MYMY 172.18.20.167/172.18.20.167:6379 setupMasterEntry -&amp;gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379 ./app.log:12310:2023-03-06 02:25:00,071 INFO org.redisson.connection.SingleEntry [redisson-netty-2-8] MYMY 172.18.20.167/172.18.20.167:6379 changeMaster -&amp;gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379 ./app.log:12353:2023-03-06 02:25:00,077 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-8] MYMY reqId = 1257 checkMasterChange -&amp;gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379 ./app.log:12354:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY scheduleChangeCheck run1267 ./app.log:12355:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY checkState reqId = 1267 ./app.log:12371:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY updateState reqId = 1267 ./app.log:12372:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY checkMasterChange reqId = 1267 ./app.log:12373:2023-03-06 02:25:00,102 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY reqId = 1267 checkMasterChange compareAndSet current = redis://172.18.20.166:6379 and newMaster = redis://172.18.20.167:6379 ./app.log:12408:2023-03-06 02:25:00,103 INFO org.redisson.connection.SingleEntry [redisson-netty-2-1] MYMY 172.18.20.167/172.18.20.167:6379 setupMasterEntry futures wait. ./app.log:12411:2023-03-06 02:25:00,104 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1267 future.whenComplete ./app.log:12412:2023-03-06 02:25:00,104 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1267 ./app.log:12503:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY scheduleChangeCheck run1268 ./app.log:12504:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY checkState reqId = 1268 ./app.log:12520:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY updateState reqId = 1268 ./app.log:12521:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY checkMasterChange reqId = 1268 ./app.log:12522:2023-03-06 02:25:01,107 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1268 future.whenComplete ./app.log:12523:2023-03-06 02:25:01,107 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1268 И в продолжении лога мы видим по строкам, что после таймаута соединения, вызывается callback с очень давнишним идентификатором reqId = 1257 т.к он ждал таймаут, а текущий идентификатор треда опроса run1267 уже ушёл вперед. ./app.log:12353:2023-03-06 02:25:00,077 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-8] MYMY reqId = 1257 checkMasterChange -&amp;gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379 ./app.log:12354:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY scheduleChangeCheck run1267 Соответственно когда callback от треда 1257 просыпаетца видит что соединения не удалось установить, он восстанавливает setupMasterEntry(соединение) и currentMaster(RedisURI) на предыдущий значения. Но при конкуренции с другим колбэком который уже ушёл вперед 1267. Это приводит к ситуации когда, exception callback восстанавливает соединение на неправильного мастера(слейва) а currentMaster перезаписывается в правильный конкурирующим колбэком. Код фунцкии без фикса: private CompletionStage&amp;lt;RedisURI&amp;gt; checkMasterChange(SentinelServersConfig cfg, RedisConnection connection) { RFuture&amp;lt;RedisURI&amp;gt; masterFuture = connection.async(StringCodec.INSTANCE, masterHostCommand, cfg.getMasterName()); return masterFuture.thenCompose(u -&amp;gt; serviceManager.resolveIP(scheme, u)) .whenComplete((newMaster, e) -&amp;gt; { if (e != null) { return; } RedisURI current = currentMaster.get(); if (!newMaster.equals(current) &amp;amp;&amp;amp; currentMaster.compareAndSet(current, newMaster)) { CompletableFuture&amp;lt;RedisClient&amp;gt; changeFuture = changeMaster(singleSlotRange.getStartSlot(), newMaster); changeFuture.exceptionally(ex -&amp;gt; { currentMaster.compareAndSet(newMaster, current); return null; }); } }); } Причина ошибки. Проблема в том что функция checkMasterChange возвращает CompletionStage а не CompletableFuture соответсвенно вышестоящий код не ждет коллбэков с ошибками а перезапускает цикл опроса sentinel серверов и тем самым устраивает конкуренцию потоков. Так выглядит пофиксенная функция от разработчика: private CompletionStage&amp;lt;RedisClient&amp;gt; checkMasterChange(SentinelServersConfig cfg, RedisConnection connection) { RFuture&amp;lt;RedisURI&amp;gt; masterFuture = connection.async(StringCodec.INSTANCE, masterHostCommand, cfg.getMasterName()); return masterFuture .thenCompose(u -&amp;gt; serviceManager.resolveIP(scheme, u)) .thenCompose(newMaster -&amp;gt; { RedisURI current = currentMaster.get(); if (!newMaster.equals(current) &amp;amp;&amp;amp; currentMaster.compareAndSet(current, newMaster)) { CompletableFuture&amp;lt;RedisClient&amp;gt; changeFuture = changeMaster(singleSlotRange.getStartSlot(), newMaster); return changeFuture.exceptionally(ex -&amp;gt; { currentMaster.compareAndSet(newMaster, current); return null; }); } return CompletableFuture.completedFuture(null); }); } Всё остальное. Стэк трейс ошибки, даже не намекает на race condition: 2023-03-06 02:24:52,037 INFO com.test.appclean.Application [main] Exception:READONLY You can&#39;t write against a read only replica.. channel: [id: 0xdc0ee8bd, L:/172.18.20.166:58492 - R:172.18.20.166/172.18.20.166:6379] command: (SET), promise: java.util.concurrent.CompletableFuture@54d0fcb4[Not completed, 1 dependents], params: [testvar, PooledUnsafeDirectByteBuf(ridx: 0, widx: 8, cap: 256)]org.redisson.client.RedisException: READONLY You can&#39;t write against a read only replica.. channel: [id: 0xdc0ee8bd, L:/172.18.20.166:58492 - R:172.18.20.166/172.18.20.166:6379] command: (SET), promise: java.util.concurrent.CompletableFuture@54d0fcb4[Not completed, 1 dependents], params: [testvar, PooledUnsafeDirectByteBuf(ridx: 0, widx: 8, cap: 256)] at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:380) at org.redisson.client.handler.CommandDecoder.decodeCommand(CommandDecoder.java:205) at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:144) at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:120) at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:529) at io.netty.handler.codec.ReplayingDecoder.callDecode(ReplayingDecoder.java:366) at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919) at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166) at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788) at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724) at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650) at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562) at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.lang.Thread.run(Thread.java:748) Пример программы для репродукции бага. package com.test.appclean; import org.redisson.Redisson; import org.redisson.api.RedissonClient; import org.redisson.config.Config; import org.redisson.config.ReadMode; import org.redisson.config.SentinelServersConfig; import org.redisson.config.SubscriptionMode; import org.redisson.connection.balancer.LoadBalancer; import org.redisson.connection.balancer.RoundRobinLoadBalancer; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import java.io.PrintWriter; import java.io.StringWriter; import java.util.Arrays; import java.util.List; public class Application { private static Logger logger = LoggerFactory.getLogger(Application.class); /** * Entry point. * * @param args agrs */ public static void main(final String[] args) throws InterruptedException { logger.info(&quot;Hello world&quot;); RedissonClient cache = createRedissonCache(); //RedissonClient database = createRedissonDatabase(); int i = 0; while (true) { try { logger.info(&quot;\nPPPPPPPPPPP set testvar to val=&quot; +i+&quot;\n&quot;); cache.getBucket(&quot;testvar&quot;).set(&quot;val=&quot; + i); } catch (Exception e) { StringWriter sw = new StringWriter(); PrintWriter pw = new PrintWriter(sw); e.printStackTrace(pw); logger.info(&quot;Exception:&quot;+e.getMessage()+sw.toString()); } i++; Thread.sleep( 1000); } //Thread.sleep(7 * 24 * 60 * 60 * 1000); } public static RedissonClient createRedissonCache() { String redisDbName = &quot;cacheMaster&quot;; String redisAddresses = &quot;redis://172.18.20.166:26379,redis://172.18.20.167:26379,redis://172.18.20.168:26379&quot;; List&amp;lt;String&amp;gt; hosts = Arrays.asList(redisAddresses.split(&quot;,&quot;)); Config config = new Config(); SentinelServersConfig connect = config.useSentinelServers().setMasterName(redisDbName); if (hosts.size() &amp;lt; 2) connect.setCheckSentinelsList(false); LoadBalancer loadBalancer = new RoundRobinLoadBalancer(); connect.setLoadBalancer(loadBalancer); connect.setSentinelAddresses(hosts); connect.setMasterConnectionMinimumIdleSize(1); connect.setSlaveConnectionMinimumIdleSize(1); connect.setReadMode(ReadMode.MASTER); connect.setSubscriptionMode(SubscriptionMode.MASTER); RedissonClient client = Redisson.create(config); return client; } } dropscript.sh: #!/bin/sh trap ctrl_c INT function ctrl_c() { echo &quot;Ctrl + C happened&quot; exit } HOSTS=&#39;172.18.20.166 172.18.20.167 172.18.20.168&#39; while [ 1 = 1 ]; do for v in $HOSTS; do echo &quot;$(date +&quot;%T&quot;) Go down host $v&quot; ssh root@$v &#39;ip link set eth0 down &amp;amp;&amp;amp; sleep 5m &amp;amp;&amp;amp; ip link set eth0 up&#39; echo &quot;$(date +&quot;%T&quot;) Go up host $v &quot; #sleep 1m # exit done echo &quot;Wait for next cycle 10s&quot; sleep 10s done Баг пофиксен в версии redisson 3.20.1, версия redis 6.2.6 которая использовалась при тестировании.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://n0rt3l.github.io/2023-05-09/redisson-bugs">

  <meta property="og:title" content="Redisson+sentinel race condition bug.">
  <meta property="og:site_name" content="/home/n0rt3l">
  <meta property="og:url" content="https://n0rt3l.github.io/2023-05-09/redisson-bugs">
  <meta property="og:description" content="Как я нашёл баг. Как то рас в одним вечерним вечером, я тестировал апликацию из связки redisson+redis+sentinel на кластере из трёх серверов. Написал скрипт который дропал каждый сервер по очереди на 5 минут, путем выключения интерфейса на сервере. Через некоторое непродолжитнльное время я получал ошибку “READONLY You can’t write against a read only replica..” создавалось ошущение что чтото не так с конфигурацией. Ещё пойзже я обнаружил что когда появляется эта ошибка, если в этот момент остановить скрипт дропа серверов, то переизбрания мастер сервера redis не происходит и ошибка остается навечно. Я конечно же проверил redis сервера нативным клиентом, оказалось что с ними всё в порядке всё пишется читается, просто мастер в этот момент не тот что у redisson. Отладка, изучение исходников. Поизучав продолжительное время исходные коды redisson проекта, а в частности инициализацию и работу опроса sentinel серверов в классе SentinelConnectionManager и всех наследуемых от него, но не как не мог понять где же может крыца ошибка, решил прибегнуть к отладке из intelliJ, чтобы посмотреть на runtime во очие. Тогда я запустил jvm с параметрами отладки примерно такими. java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8000 app.jar Поостнавливаясь рандомно, потыкая треды и найдя свой класс SentinelConnectionManager выяснилось что переменная SentinelConnectionManager.currentMaster которая указывает на текущего мастера соответсвует текущему настоящему мастеру как и на редис серверах, но соединение установленное redisson для мастер сервера SentinelConnectionManager.masterSlaveEntry.writeConnectionPool.entires имеет ClientConnectionsEntry с другим отличным от мастера ип адресом. Художественное отступление. Как же так получается воскликнул я и тот час смахнул стакан со стола. В котором был заварен долго не вытащенный, крепко перезаваренный пакетик моего любимого чая. Я схватился за волосы которые и без того покидали мою голову, и начал бегать по комнате в надежде разрешения ситуации. И через некоторое время мне пришла идея - всё разрешается отладкой. Отладка логированием. Я добавил сообщения отладки и идентификатор для треда опроса sentinel серверов и вот что я увидел: ./app.log:6691:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY scheduleChangeCheck run683 ./app.log:6692:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY checkState reqId = 683 ./app.log:6693:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY updateState reqId = 683 ./app.log:6694:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY checkMasterChange reqId = 683 ./app.log:6696:2023-03-06 02:15:02,131 INFO org.redisson.connection.SentinelConnectionManager [redisson-timer-4-1] MYMY updateState reqId = 683 future.whenComplete ./app.log:6716:2023-03-06 02:15:02,132 INFO org.redisson.connection.SentinelConnectionManager [redisson-timer-4-1] MYMY scheduleChangeCheck 683 ./app.log:6717:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY scheduleChangeCheck run684 ./app.log:6718:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY checkState reqId = 684 ./app.log:6719:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY updateState reqId = 684 ./app.log:6720:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY checkMasterChange reqId = 684 ./app.log:6721:2023-03-06 02:15:03,134 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY reqId = 684 checkMasterChange compareAndSet current = redis://172.18.20.168:6379 and newMaster = redis://172.18.20.166:6379 ./app.log:6756:2023-03-06 02:15:03,137 INFO org.redisson.connection.SingleEntry [redisson-netty-2-1] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry futures wait. ./app.log:6758:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 684 future.whenComplete ./app.log:6759:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 684 ./app.log:6765:2023-03-06 02:15:03,145 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry thenApply - complete. ./app.log:6766:2023-03-06 02:15:03,147 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 changeMaster -&amp;gt; CHANGED to 172.18.20.166/172.18.20.166:6379 ./app.log:6772:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY scheduleChangeCheck run685 ./app.log:6773:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY checkState reqId = 685 ./app.log:6774:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY updateState reqId = 685 ./app.log:6775:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY checkMasterChange reqId = 685 ./app.log:6776:2023-03-06 02:15:04,146 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-24] MYMY updateState reqId = 685 future.whenComplete ./app.log:6777:2023-03-06 02:15:04,146 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-24] MYMY scheduleChangeCheck 685 ./app.log:6778:2023-03-06 02:15:05,147 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-30] MYMY scheduleChangeCheck run686 По строкам: ./app.log:6759:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 684 ./app.log:6765:2023-03-06 02:15:03,145 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry thenApply - complete. Можно понять что callback setup setupMasterEntry отрабатывает после запуска очередного цикла опроса scheduleChangeCheck. И тут скорее всего и кроется race condition. ./app.log:12151:2023-03-06 02:24:58,094 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck run1265 ./app.log:12152:2023-03-06 02:24:58,094 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY checkState reqId = 1265 ./app.log:12168:2023-03-06 02:24:58,095 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1265 ./app.log:12169:2023-03-06 02:24:58,095 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY checkMasterChange reqId = 1265 ./app.log:12170:2023-03-06 02:24:58,096 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1265 future.whenComplete ./app.log:12171:2023-03-06 02:24:58,096 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1265 ./app.log:12230:2023-03-06 02:24:59,097 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY scheduleChangeCheck run1266 ./app.log:12231:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY checkState reqId = 1266 ./app.log:12247:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY updateState reqId = 1266 ./app.log:12248:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY checkMasterChange reqId = 1266 ./app.log:12249:2023-03-06 02:24:59,099 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1266 future.whenComplete ./app.log:12250:2023-03-06 02:24:59,099 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1266 ./app.log:12309:2023-03-06 02:25:00,071 INFO org.redisson.connection.SingleEntry [redisson-netty-2-8] MYMY 172.18.20.167/172.18.20.167:6379 setupMasterEntry -&amp;gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379 ./app.log:12310:2023-03-06 02:25:00,071 INFO org.redisson.connection.SingleEntry [redisson-netty-2-8] MYMY 172.18.20.167/172.18.20.167:6379 changeMaster -&amp;gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379 ./app.log:12353:2023-03-06 02:25:00,077 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-8] MYMY reqId = 1257 checkMasterChange -&amp;gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379 ./app.log:12354:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY scheduleChangeCheck run1267 ./app.log:12355:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY checkState reqId = 1267 ./app.log:12371:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY updateState reqId = 1267 ./app.log:12372:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY checkMasterChange reqId = 1267 ./app.log:12373:2023-03-06 02:25:00,102 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY reqId = 1267 checkMasterChange compareAndSet current = redis://172.18.20.166:6379 and newMaster = redis://172.18.20.167:6379 ./app.log:12408:2023-03-06 02:25:00,103 INFO org.redisson.connection.SingleEntry [redisson-netty-2-1] MYMY 172.18.20.167/172.18.20.167:6379 setupMasterEntry futures wait. ./app.log:12411:2023-03-06 02:25:00,104 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1267 future.whenComplete ./app.log:12412:2023-03-06 02:25:00,104 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1267 ./app.log:12503:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY scheduleChangeCheck run1268 ./app.log:12504:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY checkState reqId = 1268 ./app.log:12520:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY updateState reqId = 1268 ./app.log:12521:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY checkMasterChange reqId = 1268 ./app.log:12522:2023-03-06 02:25:01,107 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1268 future.whenComplete ./app.log:12523:2023-03-06 02:25:01,107 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1268 И в продолжении лога мы видим по строкам, что после таймаута соединения, вызывается callback с очень давнишним идентификатором reqId = 1257 т.к он ждал таймаут, а текущий идентификатор треда опроса run1267 уже ушёл вперед. ./app.log:12353:2023-03-06 02:25:00,077 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-8] MYMY reqId = 1257 checkMasterChange -&amp;gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379 ./app.log:12354:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY scheduleChangeCheck run1267 Соответственно когда callback от треда 1257 просыпаетца видит что соединения не удалось установить, он восстанавливает setupMasterEntry(соединение) и currentMaster(RedisURI) на предыдущий значения. Но при конкуренции с другим колбэком который уже ушёл вперед 1267. Это приводит к ситуации когда, exception callback восстанавливает соединение на неправильного мастера(слейва) а currentMaster перезаписывается в правильный конкурирующим колбэком. Код фунцкии без фикса: private CompletionStage&amp;lt;RedisURI&amp;gt; checkMasterChange(SentinelServersConfig cfg, RedisConnection connection) { RFuture&amp;lt;RedisURI&amp;gt; masterFuture = connection.async(StringCodec.INSTANCE, masterHostCommand, cfg.getMasterName()); return masterFuture.thenCompose(u -&amp;gt; serviceManager.resolveIP(scheme, u)) .whenComplete((newMaster, e) -&amp;gt; { if (e != null) { return; } RedisURI current = currentMaster.get(); if (!newMaster.equals(current) &amp;amp;&amp;amp; currentMaster.compareAndSet(current, newMaster)) { CompletableFuture&amp;lt;RedisClient&amp;gt; changeFuture = changeMaster(singleSlotRange.getStartSlot(), newMaster); changeFuture.exceptionally(ex -&amp;gt; { currentMaster.compareAndSet(newMaster, current); return null; }); } }); } Причина ошибки. Проблема в том что функция checkMasterChange возвращает CompletionStage а не CompletableFuture соответсвенно вышестоящий код не ждет коллбэков с ошибками а перезапускает цикл опроса sentinel серверов и тем самым устраивает конкуренцию потоков. Так выглядит пофиксенная функция от разработчика: private CompletionStage&amp;lt;RedisClient&amp;gt; checkMasterChange(SentinelServersConfig cfg, RedisConnection connection) { RFuture&amp;lt;RedisURI&amp;gt; masterFuture = connection.async(StringCodec.INSTANCE, masterHostCommand, cfg.getMasterName()); return masterFuture .thenCompose(u -&amp;gt; serviceManager.resolveIP(scheme, u)) .thenCompose(newMaster -&amp;gt; { RedisURI current = currentMaster.get(); if (!newMaster.equals(current) &amp;amp;&amp;amp; currentMaster.compareAndSet(current, newMaster)) { CompletableFuture&amp;lt;RedisClient&amp;gt; changeFuture = changeMaster(singleSlotRange.getStartSlot(), newMaster); return changeFuture.exceptionally(ex -&amp;gt; { currentMaster.compareAndSet(newMaster, current); return null; }); } return CompletableFuture.completedFuture(null); }); } Всё остальное. Стэк трейс ошибки, даже не намекает на race condition: 2023-03-06 02:24:52,037 INFO com.test.appclean.Application [main] Exception:READONLY You can&#39;t write against a read only replica.. channel: [id: 0xdc0ee8bd, L:/172.18.20.166:58492 - R:172.18.20.166/172.18.20.166:6379] command: (SET), promise: java.util.concurrent.CompletableFuture@54d0fcb4[Not completed, 1 dependents], params: [testvar, PooledUnsafeDirectByteBuf(ridx: 0, widx: 8, cap: 256)]org.redisson.client.RedisException: READONLY You can&#39;t write against a read only replica.. channel: [id: 0xdc0ee8bd, L:/172.18.20.166:58492 - R:172.18.20.166/172.18.20.166:6379] command: (SET), promise: java.util.concurrent.CompletableFuture@54d0fcb4[Not completed, 1 dependents], params: [testvar, PooledUnsafeDirectByteBuf(ridx: 0, widx: 8, cap: 256)] at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:380) at org.redisson.client.handler.CommandDecoder.decodeCommand(CommandDecoder.java:205) at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:144) at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:120) at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:529) at io.netty.handler.codec.ReplayingDecoder.callDecode(ReplayingDecoder.java:366) at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919) at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166) at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788) at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724) at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650) at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562) at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.lang.Thread.run(Thread.java:748) Пример программы для репродукции бага. package com.test.appclean; import org.redisson.Redisson; import org.redisson.api.RedissonClient; import org.redisson.config.Config; import org.redisson.config.ReadMode; import org.redisson.config.SentinelServersConfig; import org.redisson.config.SubscriptionMode; import org.redisson.connection.balancer.LoadBalancer; import org.redisson.connection.balancer.RoundRobinLoadBalancer; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import java.io.PrintWriter; import java.io.StringWriter; import java.util.Arrays; import java.util.List; public class Application { private static Logger logger = LoggerFactory.getLogger(Application.class); /** * Entry point. * * @param args agrs */ public static void main(final String[] args) throws InterruptedException { logger.info(&quot;Hello world&quot;); RedissonClient cache = createRedissonCache(); //RedissonClient database = createRedissonDatabase(); int i = 0; while (true) { try { logger.info(&quot;\nPPPPPPPPPPP set testvar to val=&quot; +i+&quot;\n&quot;); cache.getBucket(&quot;testvar&quot;).set(&quot;val=&quot; + i); } catch (Exception e) { StringWriter sw = new StringWriter(); PrintWriter pw = new PrintWriter(sw); e.printStackTrace(pw); logger.info(&quot;Exception:&quot;+e.getMessage()+sw.toString()); } i++; Thread.sleep( 1000); } //Thread.sleep(7 * 24 * 60 * 60 * 1000); } public static RedissonClient createRedissonCache() { String redisDbName = &quot;cacheMaster&quot;; String redisAddresses = &quot;redis://172.18.20.166:26379,redis://172.18.20.167:26379,redis://172.18.20.168:26379&quot;; List&amp;lt;String&amp;gt; hosts = Arrays.asList(redisAddresses.split(&quot;,&quot;)); Config config = new Config(); SentinelServersConfig connect = config.useSentinelServers().setMasterName(redisDbName); if (hosts.size() &amp;lt; 2) connect.setCheckSentinelsList(false); LoadBalancer loadBalancer = new RoundRobinLoadBalancer(); connect.setLoadBalancer(loadBalancer); connect.setSentinelAddresses(hosts); connect.setMasterConnectionMinimumIdleSize(1); connect.setSlaveConnectionMinimumIdleSize(1); connect.setReadMode(ReadMode.MASTER); connect.setSubscriptionMode(SubscriptionMode.MASTER); RedissonClient client = Redisson.create(config); return client; } } dropscript.sh: #!/bin/sh trap ctrl_c INT function ctrl_c() { echo &quot;Ctrl + C happened&quot; exit } HOSTS=&#39;172.18.20.166 172.18.20.167 172.18.20.168&#39; while [ 1 = 1 ]; do for v in $HOSTS; do echo &quot;$(date +&quot;%T&quot;) Go down host $v&quot; ssh root@$v &#39;ip link set eth0 down &amp;amp;&amp;amp; sleep 5m &amp;amp;&amp;amp; ip link set eth0 up&#39; echo &quot;$(date +&quot;%T&quot;) Go up host $v &quot; #sleep 1m # exit done echo &quot;Wait for next cycle 10s&quot; sleep 10s done Баг пофиксен в версии redisson 3.20.1, версия redis 6.2.6 которая использовалась при тестировании.">

  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

  <!-- Yandex.Metrika counter -->
	<script type="text/javascript" >
		   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
			      m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(84510148, "init", {
	           clickmap:true,
	           trackLinks:true,
	           accurateTrackBounce:true
	      });
	</script>
	<noscript><div><img src="https://mc.yandex.ru/watch/84510148" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
	<!-- /Yandex.Metrika counter --><!-- Yandex.Metrika counter -->
	<script type="text/javascript" >
		   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
			      m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(84510148, "init", {
	           clickmap:true,
	           trackLinks:true,
	           accurateTrackBounce:true
	      });
	</script>
	<noscript><div><img src="https://mc.yandex.ru/watch/84510148" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
	<!-- /Yandex.Metrika counter -->

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">/home/n0rt3l</a>

    <nav class="site-nav">
        <a class="page-link" href="https://mymywork.github.io">About</a>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Redisson+sentinel race condition bug.</h1>
    <p class="post-meta"><time datetime="2023-05-09T19:00:00+00:00" itemprop="datePublished">May 9, 2023</time>

 •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/tags/redisson/">redisson</a>
      
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h3>Как я нашёл баг.</h3>
<p>Как то рас в одним вечерним вечером, я тестировал апликацию из связки redisson+redis+sentinel
на кластере из трёх серверов. Написал скрипт который дропал каждый сервер по очереди на
5 минут, путем выключения интерфейса на сервере. Через некоторое непродолжитнльное время я получал ошибку “READONLY You can’t write against a read only replica..” создавалось ошущение
что чтото не так с конфигурацией. Ещё пойзже я обнаружил что когда появляется эта ошибка, если
в этот момент остановить скрипт дропа серверов, то переизбрания мастер сервера redis не происходит и ошибка остается навечно. Я конечно же проверил redis сервера нативным клиентом, оказалось что с ними всё в порядке всё пишется читается, просто мастер в этот момент не тот что у redisson.</p>

<h3>Отладка, изучение исходников.</h3>

<p>Поизучав продолжительное время исходные коды redisson проекта, а в частности инициализацию и работу опроса sentinel серверов в классе SentinelConnectionManager и всех наследуемых от него, но не как не мог понять где же может крыца ошибка, решил прибегнуть к отладке из intelliJ, чтобы посмотреть на runtime во очие.</p>

<p>Тогда я запустил jvm с параметрами отладки примерно такими.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8000 app.jar
</code></pre></div></div>

<p>Поостнавливаясь рандомно, потыкая треды и найдя свой класс SentinelConnectionManager выяснилось
что переменная SentinelConnectionManager.currentMaster которая указывает на текущего мастера
соответсвует текущему настоящему мастеру как и на редис серверах, но соединение установленное
redisson для мастер сервера SentinelConnectionManager.masterSlaveEntry.writeConnectionPool.entires
имеет ClientConnectionsEntry с другим отличным от мастера ип адресом.</p>

<h3>Художественное отступление.</h3>

<p>Как же так получается воскликнул я и тот час смахнул стакан со стола. В котором был заварен
долго не вытащенный, крепко перезаваренный пакетик моего любимого чая. Я схватился за волосы
которые и без того покидали мою голову, и начал бегать по комнате в надежде разрешения ситуации.
И через некоторое время мне пришла идея - всё разрешается отладкой.</p>

<h3>Отладка логированием.</h3>

<p>Я добавил сообщения отладки и идентификатор для треда опроса sentinel серверов и вот что я увидел:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./app.log:6691:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY scheduleChangeCheck run683
./app.log:6692:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY checkState reqId = 683
./app.log:6693:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY updateState reqId = 683
./app.log:6694:2023-03-06 02:14:59,036 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-9] MYMY checkMasterChange reqId = 683
./app.log:6696:2023-03-06 02:15:02,131 INFO org.redisson.connection.SentinelConnectionManager [redisson-timer-4-1] MYMY updateState reqId = 683 future.whenComplete
./app.log:6716:2023-03-06 02:15:02,132 INFO org.redisson.connection.SentinelConnectionManager [redisson-timer-4-1] MYMY scheduleChangeCheck 683
./app.log:6717:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY scheduleChangeCheck run684
./app.log:6718:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY checkState reqId = 684
./app.log:6719:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY updateState reqId = 684
./app.log:6720:2023-03-06 02:15:03,133 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-10] MYMY checkMasterChange reqId = 684
./app.log:6721:2023-03-06 02:15:03,134 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY reqId = 684 checkMasterChange compareAndSet current = redis://172.18.20.168:6379 and newMaster = redis://172.18.20.166:6379
./app.log:6756:2023-03-06 02:15:03,137 INFO org.redisson.connection.SingleEntry [redisson-netty-2-1] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry futures wait.
./app.log:6758:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 684 future.whenComplete
./app.log:6759:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 684
./app.log:6765:2023-03-06 02:15:03,145 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry thenApply - complete.
./app.log:6766:2023-03-06 02:15:03,147 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 changeMaster -&gt; CHANGED to 172.18.20.166/172.18.20.166:6379
./app.log:6772:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY scheduleChangeCheck run685
./app.log:6773:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY checkState reqId = 685
./app.log:6774:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY updateState reqId = 685
./app.log:6775:2023-03-06 02:15:04,144 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-14] MYMY checkMasterChange reqId = 685
./app.log:6776:2023-03-06 02:15:04,146 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-24] MYMY updateState reqId = 685 future.whenComplete
./app.log:6777:2023-03-06 02:15:04,146 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-24] MYMY scheduleChangeCheck 685
./app.log:6778:2023-03-06 02:15:05,147 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-30] MYMY scheduleChangeCheck run686
</code></pre></div></div>

<p>По строкам:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./app.log:6759:2023-03-06 02:15:03,142 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 684
./app.log:6765:2023-03-06 02:15:03,145 INFO org.redisson.connection.SingleEntry [redisson-netty-2-16] MYMY 172.18.20.166/172.18.20.166:6379 setupMasterEntry thenApply - complete.
</code></pre></div></div>

<p>Можно понять что callback setup setupMasterEntry отрабатывает после запуска очередного цикла опроса
scheduleChangeCheck. И тут скорее всего и кроется race condition.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./app.log:12151:2023-03-06 02:24:58,094 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck run1265
./app.log:12152:2023-03-06 02:24:58,094 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY checkState reqId = 1265
./app.log:12168:2023-03-06 02:24:58,095 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1265
./app.log:12169:2023-03-06 02:24:58,095 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY checkMasterChange reqId = 1265
./app.log:12170:2023-03-06 02:24:58,096 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1265 future.whenComplete
./app.log:12171:2023-03-06 02:24:58,096 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1265
./app.log:12230:2023-03-06 02:24:59,097 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY scheduleChangeCheck run1266
./app.log:12231:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY checkState reqId = 1266
./app.log:12247:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY updateState reqId = 1266
./app.log:12248:2023-03-06 02:24:59,098 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-5] MYMY checkMasterChange reqId = 1266
./app.log:12249:2023-03-06 02:24:59,099 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1266 future.whenComplete
./app.log:12250:2023-03-06 02:24:59,099 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1266
./app.log:12309:2023-03-06 02:25:00,071 INFO org.redisson.connection.SingleEntry [redisson-netty-2-8] MYMY 172.18.20.167/172.18.20.167:6379 setupMasterEntry -&gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379
./app.log:12310:2023-03-06 02:25:00,071 INFO org.redisson.connection.SingleEntry [redisson-netty-2-8] MYMY 172.18.20.167/172.18.20.167:6379 changeMaster -&gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379
./app.log:12353:2023-03-06 02:25:00,077 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-8] MYMY reqId = 1257 checkMasterChange -&gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379
./app.log:12354:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY scheduleChangeCheck run1267
./app.log:12355:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY checkState reqId = 1267
./app.log:12371:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY updateState reqId = 1267
./app.log:12372:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY checkMasterChange reqId = 1267
./app.log:12373:2023-03-06 02:25:00,102 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY reqId = 1267 checkMasterChange compareAndSet current = redis://172.18.20.166:6379 and newMaster = redis://172.18.20.167:6379
./app.log:12408:2023-03-06 02:25:00,103 INFO org.redisson.connection.SingleEntry [redisson-netty-2-1] MYMY 172.18.20.167/172.18.20.167:6379 setupMasterEntry futures wait.
./app.log:12411:2023-03-06 02:25:00,104 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1267 future.whenComplete
./app.log:12412:2023-03-06 02:25:00,104 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1267
./app.log:12503:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY scheduleChangeCheck run1268
./app.log:12504:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY checkState reqId = 1268
./app.log:12520:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY updateState reqId = 1268
./app.log:12521:2023-03-06 02:25:01,105 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-16] MYMY checkMasterChange reqId = 1268
./app.log:12522:2023-03-06 02:25:01,107 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY updateState reqId = 1268 future.whenComplete
./app.log:12523:2023-03-06 02:25:01,107 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-1] MYMY scheduleChangeCheck 1268
</code></pre></div></div>

<p>И в продолжении лога мы видим по строкам, что после таймаута соединения, вызывается callback с
очень давнишним идентификатором reqId = 1257 т.к он ждал таймаут, а текущий идентификатор треда
опроса run1267 уже ушёл вперед.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./app.log:12353:2023-03-06 02:25:00,077 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-8] MYMY reqId = 1257 checkMasterChange -&gt; exception = org.redisson.client.RedisConnectionException: Unable to connect to Redis server: 172.18.20.167/172.18.20.167:6379
./app.log:12354:2023-03-06 02:25:00,101 INFO org.redisson.connection.SentinelConnectionManager [redisson-netty-2-7] MYMY scheduleChangeCheck run1267
</code></pre></div></div>

<p>Соответственно когда callback от треда 1257 просыпаетца видит что соединения не удалось установить,
он восстанавливает setupMasterEntry(соединение) и currentMaster(RedisURI) на предыдущий значения.
Но при конкуренции с другим колбэком который уже ушёл вперед 1267.
Это приводит к ситуации когда, exception callback восстанавливает соединение на неправильного мастера(слейва) а currentMaster перезаписывается в правильный конкурирующим колбэком.</p>

<p>Код фунцкии без фикса:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private CompletionStage&lt;RedisURI&gt; checkMasterChange(SentinelServersConfig cfg, RedisConnection connection) {
       RFuture&lt;RedisURI&gt; masterFuture = connection.async(StringCodec.INSTANCE, masterHostCommand, cfg.getMasterName());
       return masterFuture.thenCompose(u -&gt; serviceManager.resolveIP(scheme, u))
               .whenComplete((newMaster, e) -&gt; {
           if (e != null) {
               return;
           }

           RedisURI current = currentMaster.get();
           if (!newMaster.equals(current)
                   &amp;&amp; currentMaster.compareAndSet(current, newMaster)) {
               CompletableFuture&lt;RedisClient&gt; changeFuture = changeMaster(singleSlotRange.getStartSlot(), newMaster);
               changeFuture.exceptionally(ex -&gt; {
                   currentMaster.compareAndSet(newMaster, current);
                   return null;
               });
           }
       });
   }
</code></pre></div></div>

<h3>Причина ошибки.</h3>

<p>Проблема в том что функция checkMasterChange возвращает CompletionStage<RedisURI> а не CompletableFuture соответсвенно вышестоящий код не ждет коллбэков с ошибками а перезапускает цикл опроса  sentinel серверов и тем самым устраивает конкуренцию потоков.</RedisURI></p>

<p>Так выглядит пофиксенная функция от разработчика:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private CompletionStage&lt;RedisClient&gt; checkMasterChange(SentinelServersConfig cfg, RedisConnection connection) {
    RFuture&lt;RedisURI&gt; masterFuture = connection.async(StringCodec.INSTANCE, masterHostCommand, cfg.getMasterName());
    return masterFuture
            .thenCompose(u -&gt; serviceManager.resolveIP(scheme, u))
            .thenCompose(newMaster -&gt; {
                RedisURI current = currentMaster.get();
                if (!newMaster.equals(current)
                        &amp;&amp; currentMaster.compareAndSet(current, newMaster)) {
                    CompletableFuture&lt;RedisClient&gt; changeFuture = changeMaster(singleSlotRange.getStartSlot(), newMaster);
                    return changeFuture.exceptionally(ex -&gt; {
                        currentMaster.compareAndSet(newMaster, current);
                        return null;
                    });
                }
                return CompletableFuture.completedFuture(null);
            });
}
</code></pre></div></div>

<h3>Всё остальное.</h3>

<p>Стэк трейс ошибки, даже не намекает на race condition:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2023-03-06 02:24:52,037 INFO com.test.appclean.Application [main] Exception:READONLY You can't write against a read only replica.. channel: [id: 0xdc0ee8bd, L:/172.18.20.166:58492 - R:172.18.20.166/172.18.20.166:6379] command: (SET), promise: java.util.concurrent.CompletableFuture@54d0fcb4[Not completed, 1 dependents], params: [testvar, PooledUnsafeDirectByteBuf(ridx: 0, widx: 8, cap: 256)]org.redisson.client.RedisException: READONLY You can't write against a read only replica.. channel: [id: 0xdc0ee8bd, L:/172.18.20.166:58492 - R:172.18.20.166/172.18.20.166:6379] command: (SET), promise: java.util.concurrent.CompletableFuture@54d0fcb4[Not completed, 1 dependents], params: [testvar, PooledUnsafeDirectByteBuf(ridx: 0, widx: 8, cap: 256)]
  at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:380)
  at org.redisson.client.handler.CommandDecoder.decodeCommand(CommandDecoder.java:205)
  at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:144)
  at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:120)
  at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:529)
  at io.netty.handler.codec.ReplayingDecoder.callDecode(ReplayingDecoder.java:366)
  at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)
  at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)
  at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
  at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)
  at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)
  at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)
  at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)
  at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)
  at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)
  at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)
  at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)
  at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)
  at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)
  at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)
  at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
  at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
  at java.lang.Thread.run(Thread.java:748)

</code></pre></div></div>

<p>Пример программы для репродукции бага.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package com.test.appclean;

import org.redisson.Redisson;
import org.redisson.api.RedissonClient;
import org.redisson.config.Config;
import org.redisson.config.ReadMode;
import org.redisson.config.SentinelServersConfig;
import org.redisson.config.SubscriptionMode;
import org.redisson.connection.balancer.LoadBalancer;
import org.redisson.connection.balancer.RoundRobinLoadBalancer;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.Arrays;
import java.util.List;


public class Application {
    private static Logger logger = LoggerFactory.getLogger(Application.class);

    /**
     * Entry point.
     *
     * @param args agrs
     */
    public static void main(final String[] args) throws InterruptedException {
        logger.info("Hello world");

        RedissonClient cache = createRedissonCache();
        //RedissonClient database = createRedissonDatabase();
        int i = 0;
        while (true) {
            try {
                logger.info("\nPPPPPPPPPPP set testvar to val=" +i+"\n");
                cache.getBucket("testvar").set("val=" + i);
            } catch (Exception e) {
                StringWriter sw = new StringWriter();
                PrintWriter pw = new PrintWriter(sw);
                e.printStackTrace(pw);
                logger.info("Exception:"+e.getMessage()+sw.toString());
            }
            i++;
            Thread.sleep( 1000);
        }
        //Thread.sleep(7 * 24 * 60 * 60 * 1000);
    }

    public static RedissonClient createRedissonCache() {

        String redisDbName = "cacheMaster";
        String redisAddresses = "redis://172.18.20.166:26379,redis://172.18.20.167:26379,redis://172.18.20.168:26379";

        List&lt;String&gt; hosts = Arrays.asList(redisAddresses.split(","));

        Config config = new Config();

        SentinelServersConfig connect = config.useSentinelServers().setMasterName(redisDbName);
        if (hosts.size() &lt; 2) connect.setCheckSentinelsList(false);
        LoadBalancer loadBalancer = new RoundRobinLoadBalancer();

        connect.setLoadBalancer(loadBalancer);
        connect.setSentinelAddresses(hosts);
        connect.setMasterConnectionMinimumIdleSize(1);
        connect.setSlaveConnectionMinimumIdleSize(1);

        connect.setReadMode(ReadMode.MASTER);
        connect.setSubscriptionMode(SubscriptionMode.MASTER);

        RedissonClient client = Redisson.create(config);
        return client;
    }

}
</code></pre></div></div>

<p>dropscript.sh:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/sh

trap ctrl_c INT
function ctrl_c() {
    echo "Ctrl + C happened"
    exit
}

HOSTS='172.18.20.166 172.18.20.167 172.18.20.168'

while [ 1 = 1 ]; do
  for v in $HOSTS; do
    echo "$(date +"%T") Go down host $v"
    ssh root@$v 'ip link set eth0 down &amp;&amp; sleep 5m &amp;&amp; ip link set eth0 up'
    echo "$(date +"%T") Go up host $v "
    #sleep 1m
   # exit
  done
  echo "Wait for next cycle 10s"
  sleep 10s
done
</code></pre></div></div>

<p>Баг пофиксен в версии redisson 3.20.1, версия redis 6.2.6 которая использовалась при тестировании.</p>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      &copy; nortel - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; Modded <a href="https://github.com/yous/whiteglass">whiteglass</a>

    </p>

  </div>

</footer>


  </body>

</html>
